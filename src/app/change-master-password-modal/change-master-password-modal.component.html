<ion-header class="ion-no-border">
  <ion-toolbar class="modal-toolbar">
    <ion-title class="modal-title">Alterar Senha Mestra</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="closeModal()" class="close-button" [disabled]="isChanging">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modal-content">
  <div class="modal-container">
    
    <!-- Estado Normal/Alterando -->
    <div *ngIf="!isSuccess" class="form-container">
      
      <!-- Warning Banner -->
      <div class="warning-banner">
        <ion-icon name="alert-circle" class="warning-icon"></ion-icon>
        <div class="warning-content">
          <strong>Atenção!</strong> Você precisará desta senha para acessar o PassGuard. 
          Certifique-se de memorizá-la ou guardá-la em local seguro.
        </div>
      </div>

      <!-- Senha Atual -->
      <div class="form-section">
        <h3 class="section-title">Senha Atual</h3>
        
        <div class="input-group">
          <ion-label class="input-label">Digite sua senha atual</ion-label>
          <div class="password-input-wrapper">
            <ion-input
              [(ngModel)]="currentPassword"
              [type]="showCurrentPassword ? 'text' : 'password'"
              placeholder="••••••••"
              class="custom-input"
              [class.error]="currentPasswordError"
              [disabled]="isChanging"
              (ionInput)="currentPasswordError = false"
            ></ion-input>
            <ion-button
              fill="clear"
              class="toggle-password-btn"
              (click)="togglePasswordVisibility('current')"
              [disabled]="isChanging"
            >
              <ion-icon [name]="showCurrentPassword ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </div>
          <p *ngIf="currentPasswordError" class="error-message">
            <ion-icon name="alert-circle"></ion-icon>
            Senha incorreta
          </p>
        </div>
      </div>

      <!-- Nova Senha -->
      <div class="form-section">
        <h3 class="section-title">Nova Senha</h3>
        
        <div class="input-group">
          <ion-label class="input-label">Digite sua nova senha</ion-label>
          <div class="password-input-wrapper">
            <ion-input
              [(ngModel)]="newPassword"
              [type]="showNewPassword ? 'text' : 'password'"
              placeholder="••••••••"
              class="custom-input"
              (ionInput)="onNewPasswordChange()"
              [disabled]="isChanging"
            ></ion-input>
            <ion-button
              fill="clear"
              class="toggle-password-btn"
              (click)="togglePasswordVisibility('new')"
              [disabled]="isChanging"
            >
              <ion-icon [name]="showNewPassword ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </div>
        </div>

        <!-- Requisitos da Senha -->
        <div class="requirements-container" *ngIf="newPassword">
          <p class="requirements-title">Requisitos da senha:</p>
          <div class="requirements-list">
            <div 
              *ngFor="let req of passwordRequirements" 
              class="requirement-item"
              [class.met]="req.met"
            >
              <ion-icon 
                [name]="req.met ? 'checkmark-circle' : 'alert-circle'"
                class="requirement-icon"
              ></ion-icon>
              <span class="requirement-text">{{ req.label }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmar Nova Senha -->
      <div class="form-section">
        <h3 class="section-title">Confirmar Nova Senha</h3>
        
        <div class="input-group">
          <ion-label class="input-label">Digite novamente a nova senha</ion-label>
          <div class="password-input-wrapper">
            <ion-input
              [(ngModel)]="confirmPassword"
              [type]="showConfirmPassword ? 'text' : 'password'"
              placeholder="••••••••"
              class="custom-input"
              [class.success]="passwordsMatch"
              [class.error]="passwordsDontMatch"
              [disabled]="isChanging"
            ></ion-input>
            <ion-button
              fill="clear"
              class="toggle-password-btn"
              (click)="togglePasswordVisibility('confirm')"
              [disabled]="isChanging"
            >
              <ion-icon [name]="showConfirmPassword ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </div>
          
          <p *ngIf="passwordsMatch" class="success-message">
            <ion-icon name="checkmark-circle"></ion-icon>
            As senhas coincidem
          </p>
          
          <p *ngIf="passwordsDontMatch" class="error-message">
            <ion-icon name="alert-circle"></ion-icon>
            As senhas não coincidem
          </p>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="modal-actions">
        <ion-button
          expand="block"
          fill="outline"
          class="cancel-button"
          (click)="cancel()"
          [disabled]="isChanging"
        >
          Cancelar
        </ion-button>
        
        <ion-button
          expand="block"
          class="change-button"
          (click)="changePassword()"
          [disabled]="!canSubmit || isChanging"
        >
          <ion-spinner *ngIf="isChanging" name="crescent"></ion-spinner>
          <span *ngIf="!isChanging">Alterar Senha</span>
        </ion-button>
      </div>
    </div>

    <!-- Estado Sucesso -->
    <div *ngIf="isSuccess" class="success-state">
      <div class="icon-container success">
        <ion-icon name="shield-checkmark" class="success-icon"></ion-icon>
      </div>
      
      <h2 class="success-title">Senha Alterada!</h2>
      
      <p class="success-description">
        Sua senha mestra foi alterada com sucesso. Use a nova senha na próxima vez que acessar o PassGuard.
      </p>
    </div>

  </div>
</ion-content>